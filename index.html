<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    <style>
        :root { 
            --primary: #2e7d32; --accent: #f57c00; --bg: #f1f3f4; 
            --text: #202124; --danger: #d93025; --card-bg: #ffffff;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        header { background: var(--primary); color: white; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; position: sticky; top: 0; z-index: 1000; }
        
        .container { max-width: 800px; margin: auto; padding: 15px; }
        
        /* Dashboard */
        .dashboard { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-label { font-size: 0.8rem; color: #5f6368; display: block; }
        .stat-value { font-size: 1.2rem; font-weight: bold; color: var(--primary); }

        /* Tabs */
        .tabs { display: flex; background: white; margin: -15px -15px 20px -15px; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #5f6368; font-weight: bold; transition: 0.3s; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #f8f9fa; }

        .section { display: none; }
        .section.active { display: block; }

        /* Forms */
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.9rem; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        
        /* Client History Card */
        .client-card { background: white; border-radius: 15px; overflow: hidden; margin-bottom: 20px; border: 1px solid #eee; }
        .client-header { background: #f8f9fa; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .client-name { font-size: 1.1rem; font-weight: bold; color: var(--primary); }
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .history-table th { background: #fafafa; padding: 10px; text-align: right; border-bottom: 1px solid #eee; }
        .history-table td { padding: 10px; border-bottom: 1px solid #f5f5f5; }
        
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-expense { background: var(--accent); color: white; }
        .btn-wa { background: #25D366; color: white; margin-top: 0; padding: 5px 10px; font-size: 0.8rem; width: auto; }
        .btn-call { background: #0288d1; color: white; padding: 5px 10px; font-size: 0.8rem; width: auto; }

        .total-row { background: #e8f5e9; font-weight: bold; }
        .badge { padding: 3px 8px; border-radius: 5px; font-size: 0.75rem; font-weight: bold; }
        .badge-debt { background: #fce8e6; color: #d93025; }
        .badge-paid { background: #e6ffed; color: #1e7e34; }
    </style>
</head>
<body>

<header>ğŸšœ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ</header>

<div class="container">
    <div class="dashboard">
        <div class="stat-card">
            <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„</span>
            <span id="statIncome" class="stat-value">0</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</span>
            <span id="statExpense" class="stat-value" style="color:var(--danger)">0</span>
        </div>
        <div class="stat-card" style="grid-column: span 2; background: #e8f5e9;">
            <span class="stat-label">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</span>
            <span id="statNet" class="stat-value" style="font-size: 1.5rem;">0</span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('work')">ğŸ  Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†</div>
        <div class="tab" onclick="switchTab('expenses')">â›½ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
        <div class="tab" onclick="switchTab('history')">ğŸ‘¥ Ø³Ø¬Ù„ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</div>
    </div>

    <div id="workSection" class="section active">
        <div class="card">
            <h3>ØªØ³Ø¬ÙŠÙ„ ÙŠÙˆÙ… Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯</h3>
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
                <input type="text" id="clientName" placeholder="Ø§Ø¨Ø­Ø« Ø£Ùˆ Ø£Ø¶Ù Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯" list="namesList">
                <datalist id="namesList"></datalist>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <div class="form-group"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="workDate"></div>
                <div class="form-group"><label>Ø§Ù„Ù…ÙƒØ§Ù†</label><input type="text" id="workLoc" placeholder="Ø§Ù„Ù…Ø²Ø±Ø¹Ø©"></div>
                <div class="form-group"><label>Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                    <select id="serviceType">
                        <option>Ø­Ø±Ø§Ø«Ø©</option><option>Ù‚ØµØ§Ø¨ÙŠØ©</option><option>Ù†Ù‚Ù„</option><option>ØªÙ†Ø¹ÙŠÙ…</option>
                    </select>
                </div>
                <div class="form-group"><label>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</label><input type="number" id="workHours" step="0.5"></div>
                <div class="form-group"><label>Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©</label><input type="number" id="hourPrice"></div>
                <div class="form-group"><label>Ø§Ù„Ø¯ÙØ¹</label>
                    <select id="payStatus">
                        <option value="Ø£Ø¬Ù„">Ø£Ø¬Ù„ (Ø¯ÙŠÙ†)</option><option value="Ù…Ù‚Ø¯Ù…">Ø®Ø§Ù„Øµ</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Ù‡Ø§ØªÙ Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
                <input type="tel" id="clientPhone" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
            </div>
            <button class="btn btn-primary" onclick="addWork()">ğŸ’¾ Ø­ÙØ¸ ÙŠÙˆÙ… Ø§Ù„Ø¹Ù…Ù„</button>
        </div>
    </div>

    <div id="expensesSection" class="section">
        <div class="card">
            <h3>ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ (Ø¯ÙŠØ²Ù„ / ØµÙŠØ§Ù†Ø©)</h3>
            <div class="form-group"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="expDate"></div>
            <div class="form-group"><label>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                <select id="expType">
                    <option>Ø¯ÙŠØ²Ù„</option><option>Ø²ÙŠØª</option><option>ØµÙŠØ§Ù†Ø©</option><option>Ø£Ø®Ø±Ù‰</option>
                </select>
            </div>
            <div class="form-group"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="expAmount"></div>
            <button class="btn btn-expense" onclick="addExpense()">ğŸ’¸ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
        </div>
        <div id="expList"></div>
    </div>

    <div id="historySection" class="section">
        <input type="text" id="searchClient" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†..." oninput="renderHistory()" style="margin-bottom:15px">
        <div id="clientHistoryList"></div>
    </div>
</div>

<script>
    let data = JSON.parse(localStorage.getItem('tractor_final_db')) || { work: [], expenses: [] };

    document.getElementById('workDate').valueAsDate = new Date();
    document.getElementById('expDate').valueAsDate = new Date();

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById(tab + 'Section').classList.add('active');
        if(tab === 'history') renderHistory();
        if(tab === 'expenses') renderExpenses();
    }

    function addWork() {
        const entry = {
            id: Date.now(),
            name: document.getElementById('clientName').value.trim(),
            date: document.getElementById('workDate').value,
            location: document.getElementById('workLoc').value,
            service: document.getElementById('serviceType').value,
            hours: parseFloat(document.getElementById('workHours').value) || 0,
            price: parseFloat(document.getElementById('hourPrice').value) || 0,
            payStatus: document.getElementById('payStatus').value,
            phone: document.getElementById('clientPhone').value
        };

        if(!entry.name || !entry.hours) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        data.work.push(entry);
        save();
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
        document.getElementById('workHours').value = '';
    }

    function addExpense() {
        const exp = {
            id: Date.now(),
            date: document.getElementById('expDate').value,
            type: document.getElementById('expType').value,
            amount: parseFloat(document.getElementById('expAmount').value) || 0
        };
        if(!exp.amount) return;
        data.expenses.push(exp);
        save();
        renderExpenses();
    }

    function save() {
        localStorage.setItem('tractor_final_db', JSON.stringify(data));
        updateDashboard();
    }

    function updateDashboard() {
        const income = data.work.reduce((s, w) => s + (w.hours * w.price), 0);
        const expenses = data.expenses.reduce((s, e) => s + e.amount, 0);
        document.getElementById('statIncome').innerText = income.toLocaleString();
        document.getElementById('statExpense').innerText = expenses.toLocaleString();
        document.getElementById('statNet').innerText = (income - expenses).toLocaleString();
        
        const names = [...new Set(data.work.map(w => w.name))];
        document.getElementById('namesList').innerHTML = names.map(n => `<option value="${n}">`).join('');
    }

    function renderHistory() {
        const query = document.getElementById('searchClient').value.toLowerCase();
        const container = document.getElementById('clientHistoryList');
        container.innerHTML = '';

        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†
        const grouped = data.work.reduce((acc, curr) => {
            if(!acc[curr.name]) acc[curr.name] = { items: [], phone: curr.phone };
            acc[curr.name].items.push(curr);
            return acc;
        }, {});

        for(let name in grouped) {
            if(!name.toLowerCase().includes(query)) continue;

            const client = grouped[name];
            let clientTotal = 0;
            let clientDebt = 0;

            const card = document.createElement('div');
            card.className = 'client-card';
            
            let tableRows = client.items.map(item => {
                const rowTotal = item.hours * item.price;
                clientTotal += rowTotal;
                if(item.payStatus === 'Ø£Ø¬Ù„') clientDebt += rowTotal;
                
                return `<tr>
                    <td>${item.date}</td>
                    <td>${item.service}<br><small>ğŸ“ ${item.location}</small></td>
                    <td>${item.hours} Ø³</td>
                    <td>${rowTotal}</td>
                </tr>`;
            }).join('');

            card.innerHTML = `
                <div class="client-header">
                    <div>
                        <span class="client-name">${name}</span><br>
                        <small>Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <b style="color:red">${clientDebt}</b></small>
                    </div>
                    <div style="display:flex; gap:5px">
                        <button class="btn-call" onclick="window.open('tel:${client.phone}')">ğŸ“</button>
                        <button class="btn-wa" onclick="shareClientWA('${name}')">ğŸ’¬</button>
                    </div>
                </div>
                <table class="history-table">
                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø³Ø§Ø¹Ø§Øª</th><th>Ù…Ø¨Ù„Øº</th></tr></thead>
                    <tbody>${tableRows}</tbody>
                    <tfoot><tr class="total-row"><td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</td><td>${clientTotal}</td></tr></tfoot>
                </table>
            `;
            container.appendChild(card);
        }
    }

    function renderExpenses() {
        const list = document.getElementById('expList');
        list.innerHTML = data.expenses.slice().reverse().map(e => `
            <div class="card" style="padding:10px; margin-bottom:10px; border-left:4px solid var(--accent)">
                <div style="display:flex; justify-content:space-between">
                    <span><b>${e.type}</b> <small>(${e.date})</small></span>
                    <span style="color:var(--danger)">${e.amount}</span>
                </div>
            </div>
        `).join('');
    }

    function shareClientWA(name) {
        const client = data.work.filter(w => w.name === name);
        let debt = client.reduce((s, w) => w.payStatus === 'Ø£Ø¬Ù„' ? s + (w.hours * w.price) : s, 0);
        let msg = `*ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø¹Ù…Ù„ Ø§Ù„Ø¬Ø±Ø§Ø±*%0A*Ø§Ù„Ø²Ø¨ÙˆÙ†:* ${name}%0A------------------%0A`;
        client.forEach(c => {
            msg += `ğŸ“… ${c.date} | ${c.service} | ${c.hours * c.price}%0A`;
        });
        msg += `------------------%0AğŸ’° *Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø¯ÙŠÙ†): ${debt}*`;
        window.open(`https://wa.me/${client[0].phone}?text=${msg}`);
    }

    updateDashboard();
</script>
</body>
</html>
