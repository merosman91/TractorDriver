<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±ÙÙŠÙ‚ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ - Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©</title>
    <meta name="theme-color" content="#4CAF50">
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #2E7D32; --secondary: #f57c00; --bg: #f3f4f6; --text: #1f2937; --danger: #d32f2f; --info: #0288d1; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; padding-bottom: 100px; }
        
        header { background-color: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .container { max-width: 600px; margin: 0 auto; padding: 10px; }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-group { flex: 1; margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.85rem; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        input:focus, select:focus { border-color: var(--primary); outline: none; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-save { background-color: var(--primary); }
        .btn-cancel { background-color: #757575; display: none; margin-top: 5px; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« */
        .search-box { margin-bottom: 15px; position: relative; }
        .search-box input { padding-right: 35px; border-radius: 25px; border: 2px solid var(--primary); }
        
        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ø§Ù„Ù…Ù‡Ù…Ø©) */
        .task-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 12px; border-right: 6px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .client-name { font-weight: bold; font-size: 1.1rem; color: var(--primary); }
        .service-badge { background: #e8f5e9; color: var(--primary); padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        
        .card-details { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9rem; color: #555; }
        .detail-item strong { display: block; color: #333; font-size: 0.8rem; }
        .total-price { color: var(--danger); font-weight: bold; font-size: 1.1rem; }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
        .actions-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 12px; border-top: 1px solid #eee; padding-top: 10px; }
        .action-btn { background: none; border: 1px solid #ddd; border-radius: 6px; padding: 6px; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .btn-whatsapp { color: #25D366; border-color: #25D366; }
        .btn-call { color: var(--info); border-color: var(--info); }
        .btn-edit { color: var(--secondary); border-color: var(--secondary); }
        .btn-delete { color: var(--danger); border-color: var(--danger); }
        .action-btn:active { background: #eee; }

        /* Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ø§Ø¦Ù… */
        .floating-stats { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-around; font-weight: bold; font-size: 0.9rem; z-index: 900; }
        .stat-item span { color: var(--primary); }
    </style>
</head>
<body>

<header>
    <h1>ğŸšœ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹</h1>
</header>

<div class="container">
    
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù„Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ±Ù‡)..." oninput="renderTasks()">
        <span style="position: absolute; right: 10px; top: 10px;">ğŸ”</span>
    </div>

    <div class="card" id="formCard">
        <h3 style="margin-top:0" id="formTitle">ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯</h3>
        
        <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <input type="text" id="clientName" placeholder="Ø§Ù„Ø§Ø³Ù…">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="workDate">
            </div>
            <div class="form-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                <select id="serviceType">
                    <option value="Ø­Ø±Ø§Ø«Ø©">Ø­Ø±Ø§Ø«Ø©</option>
                    <option value="Ù‚ØµØ§Ø¨ÙŠØ©">Ù‚ØµØ§Ø¨ÙŠØ©</option>
                    <option value="ØªÙ†Ø¹ÙŠÙ…">ØªÙ†Ø¹ÙŠÙ…</option>
                    <option value="ØªØ®Ø·ÙŠØ·">ØªØ®Ø·ÙŠØ·</option>
                    <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</label>
                <input type="number" id="workHours" placeholder="0" step="0.5" oninput="calculatePreview()">
            </div>
            <div class="form-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©</label>
                <input type="number" id="hourlyRate" placeholder="Ù…Ø«Ù„Ø§Ù‹: 100" oninput="calculatePreview()">
            </div>
        </div>

        <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="tel" id="clientPhone" placeholder="05xxxxxxxx">
        </div>

        <div style="text-align:center; margin-bottom:10px; color:var(--primary); font-weight:bold" id="previewTotal">
            Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: 0
        </div>

        <button class="btn btn-save" onclick="saveTask()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
        <button class="btn btn-cancel" id="cancelEditBtn" onclick="cancelEdit()">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
    </div>

    <div id="taskList"></div>
    <div style="height: 50px;"></div> </div>

<div class="floating-stats">
    <div class="stat-item">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº: <span id="totalMoney">0</span></div>
    <div class="stat-item">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª: <span id="totalHours">0</span></div>
</div>

<script>
    // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª ---
    let tasks = JSON.parse(localStorage.getItem('tractorTasks_v2')) || [];
    let editingId = null; // Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ØªÙŠ ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹

    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙˆØ§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ù† Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ©
    document.getElementById('workDate').valueAsDate = new Date();
    const lastRate = localStorage.getItem('lastHourlyRate');
    if(lastRate) document.getElementById('hourlyRate').value = lastRate;

    // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---

    // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ù…Ø¨Ù„Øº
    function calculatePreview() {
        const h = parseFloat(document.getElementById('workHours').value) || 0;
        const r = parseFloat(document.getElementById('hourlyRate').value) || 0;
        document.getElementById('previewTotal').innerText = `Ø§Ù„Ù…Ø¨Ù„Øº: ${(h * r).toLocaleString()} Ø¹Ù…Ù„Ø©`;
    }

    // 2. Ø­ÙØ¸ (Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„)
    function saveTask() {
        const name = document.getElementById('clientName').value.trim();
        const date = document.getElementById('workDate').value;
        const service = document.getElementById('serviceType').value;
        const hours = parseFloat(document.getElementById('workHours').value);
        const rate = parseFloat(document.getElementById('hourlyRate').value);
        const phone = document.getElementById('clientPhone').value;

        if (!name || !hours || !rate || !date) {
            alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø³Ø§Ø¹Ø§ØªØŒ Ø§Ù„Ø³Ø¹Ø±)');
            return;
        }

        // Ø­ÙØ¸ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
        localStorage.setItem('lastHourlyRate', rate);

        if (editingId) {
            // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            const index = tasks.findIndex(t => t.id === editingId);
            if (index !== -1) {
                tasks[index] = { ...tasks[index], name, date, service, hours, rate, phone };
            }
            editingId = null;
            document.getElementById('formTitle').innerText = "ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯";
            document.getElementById('cancelEditBtn').style.display = 'none';
        } else {
            // Ø­Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯
            const newTask = {
                id: Date.now(),
                name, date, service, hours, rate, phone
            };
            tasks.unshift(newTask);
        }

        saveToLocal();
        resetForm();
    }

    // 3. ØªØ­Ø¶ÙŠØ± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    function editTask(id) {
        const task = tasks.find(t => t.id === id);
        if (!task) return;

        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        document.getElementById('clientName').value = task.name;
        document.getElementById('workDate').value = task.date;
        document.getElementById('serviceType').value = task.service;
        document.getElementById('workHours').value = task.hours;
        document.getElementById('hourlyRate').value = task.rate;
        document.getElementById('clientPhone').value = task.phone || '';

        // ØªØºÙŠÙŠØ± ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        editingId = id;
        document.getElementById('formTitle').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„: " + task.name;
        document.getElementById('cancelEditBtn').style.display = 'block';
        calculatePreview();
        
        // Ø§Ù„ØµØ¹ÙˆØ¯ Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('formCard').scrollIntoView({behavior: 'smooth'});
    }

    function cancelEdit() {
        editingId = null;
        resetForm();
        document.getElementById('formTitle').innerText = "ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯";
        document.getElementById('cancelEditBtn').style.display = 'none';
    }

    // 4. Ø§Ù„Ø­Ø°Ù
    function deleteTask(id) {
        if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
            tasks = tasks.filter(t => t.id !== id);
            saveToLocal();
        }
    }

    // 5. Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (ØªØ®Ø²ÙŠÙ†ØŒ Ù…Ø³Ø­ØŒ Ø¹Ø±Ø¶)
    function saveToLocal() {
        localStorage.setItem('tractorTasks_v2', JSON.stringify(tasks));
        renderTasks();
    }

    function resetForm() {
        document.getElementById('clientName').value = '';
        document.getElementById('workHours').value = '';
        document.getElementById('clientPhone').value = '';
        document.getElementById('previewTotal').innerText = 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: 0';
        // Ù„Ø§ Ù†Ù…Ø³Ø­ Ø§Ù„Ø³Ø¹Ø± ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±
    }

    // 6. ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ§Ù„Ø§ØªØµØ§Ù„
    function openWhatsApp(id) {
        const t = tasks.find(i => i.id === id);
        const total = t.hours * t.rate;
        
        const text = `ğŸ“‹ *ØªÙ‚Ø±ÙŠØ± Ø¹Ù…Ù„ (Ø¬Ø±Ø§Ø± Ø²Ø±Ø§Ø¹ÙŠ)*%0a` +
                     `ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${t.name}%0a` +
                     `ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${t.date}%0a` +
                     `ğŸšœ Ø§Ù„Ø®Ø¯Ù…Ø©: ${t.service}%0a` +
                     `â± Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª: ${t.hours} Ø³Ø§Ø¹Ø©%0a` +
                     `ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ø³Ø§Ø¹Ø©: ${t.rate}%0a` +
                     `------------------%0a` +
                     `ğŸ’µ *Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${total.toLocaleString()}*`;
        
        const number = t.phone ? t.phone.replace(/[^0-9]/g, '') : ''; 
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…ØŒ ÙŠÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„
        window.open(`https://wa.me/${number}?text=${text}`, '_blank');
    }

    function callClient(phone) {
        if (!phone) {
            alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„');
            return;
        }
        window.open(`tel:${phone}`);
    }

    // 7. Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ÙÙ„ØªØ±Ø© (Render)
    function renderTasks() {
        const list = document.getElementById('taskList');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        list.innerHTML = '';
        
        let grandTotalMoney = 0;
        let grandTotalHours = 0;

        // ØªØµÙÙŠØ© Ø§Ù„Ù…Ù‡Ø§Ù… Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«
        const filteredTasks = tasks.filter(t => t.name.toLowerCase().includes(searchTerm));

        filteredTasks.forEach(t => {
            const totalPrice = t.hours * t.rate;
            grandTotalMoney += totalPrice;
            grandTotalHours += t.hours;

            const div = document.createElement('div');
            div.className = 'task-card';
            div.innerHTML = `
                <div class="card-header">
                    <div>
                        <div class="client-name">${t.name}</div>
                        <span style="font-size:0.8rem; color:#888">${t.date}</span>
                    </div>
                    <span class="service-badge">${t.service}</span>
                </div>
                
                <div class="card-details">
                    <div class="detail-item"><strong>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</strong>${t.hours} Ø³Ø§Ø¹Ø©</div>
                    <div class="detail-item"><strong>Ø§Ù„Ø³Ø¹Ø±/Ø³Ø§Ø¹Ø©</strong>${t.rate}</div>
                    <div class="detail-item" style="grid-column: span 2; margin-top:5px">
                        <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</strong>
                        <span class="total-price">${totalPrice.toLocaleString()}</span>
                    </div>
                </div>

                <div class="actions-bar">
                    <button class="action-btn btn-call" onclick="callClient('${t.phone}')" title="Ø§ØªØµØ§Ù„">ğŸ“</button>
                    <button class="action-btn btn-whatsapp" onclick="openWhatsApp(${t.id})" title="ÙˆØ§ØªØ³Ø§Ø¨">ğŸ’¬</button>
                    <button class="action-btn btn-edit" onclick="editTask(${t.id})" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                    <button class="action-btn btn-delete" onclick="deleteTask(${t.id})" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                </div>
            `;
            list.appendChild(div);
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ
        document.getElementById('totalMoney').innerText = grandTotalMoney.toLocaleString();
        document.getElementById('totalHours').innerText = grandTotalHours;
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨Ø­Ø«ØŒ Ù†Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ù…Ù„Ø®Øµ
        if (searchTerm) {
            document.querySelector('.floating-stats').style.backgroundColor = '#e3f2fd';
        } else {
            document.querySelector('.floating-stats').style.backgroundColor = 'white';
        }
    }

    // Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    renderTasks();
    
    // Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
</script>

</body>
</html>
